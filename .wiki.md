# 易签宝 PHP SDK 文档

本文档详细介绍了易签宝 PHP SDK (V3 API) 的各个服务及方法的使用说明。

## 目录

- [安装与配置](#安装与配置)
- [核心概念](#核心概念)
- [服务列表](#服务列表)
    - [认证服务 (AuthService)](#认证服务-authservice)
    - [文件服务 (FileService)](#文件服务-fileservice)
    - [模板服务 (TemplateService)](#模板服务-templateservice)
    - [签署流程服务 (SignFlowService)](#签署流程服务-signflowservice)
- [错误处理](#错误处理)

---

## 安装与配置

### 安装

```bash
composer require qingze-lab/esignbao-sdk-php
```

### 初始化

```php
use QingzeLab\ESignBao\Client;
use QingzeLab\ESignBao\Config\Configuration;

// 初始化配置
$config = new Configuration(
    appId: 'your_app_id',
    appSecret: 'your_app_secret',
    apiBaseUrl: 'https://smlopenapi.esign.cn' // 沙箱环境地址，正式环境请使用 https://openapi.esign.cn
);

// 可选配置
$config->setTimeout(30)            // 请求超时时间（秒）
       ->setConnectTimeout(5.0)    // 连接超时时间（秒）
       ->setMaxRetries(3);         // 失败重试次数

// 实例化客户端
$client = new Client($config);
```

---

## 核心概念

SDK 采用领域服务（Domain Service）模式，通过主 `Client` 类访问各个具体的服务：

- `$client->auth()`: 处理实名认证相关业务
- `$client->file()`: 处理文件上传、下载、模板创建等业务
- `$client->template()`: 处理合同模板填写、查询等业务
- `$client->signFlow()`: 处理签署流程的创建、发起、查询、归档等业务

---

## 服务列表

### 认证服务 (AuthService)

用于处理个人和机构的实名认证。

#### 1. 获取个人认证&授权页面链接
`getPersonAuthUrl`

```php
$result = $client->auth()->getPersonAuthUrl(
    psnAuthConfig: [
        'psnAccount' => '188****8888', // 个人账号标识（手机号/邮箱）
    ],
    redirectConfig: [
        'redirectUrl' => 'https://your-site.com/callback' // 认证完成后跳转地址
    ]
);
// 返回: ['authUrl' => '...', 'authFlowId' => '...']
```

#### 2. 获取机构认证&授权页面链接
`getOrganizationAuthUrl`

```php
$result = $client->auth()->getOrganizationAuthUrl(
    orgAuthConfig: [
        'orgName' => 'xx有限公司'
    ],
    authorizeConfig: [
        'authorizedPsnAccount' => '188****8888' // 授权人账号
    ]
);
```

#### 3. 查询认证授权流程详情
`getAuthFlowDetail`

```php
$detail = $client->auth()->getAuthFlowDetail('auth_flow_id');
```

#### 4. 查询个人/机构认证信息
`getPersonIdentityInfo` / `getOrganizationIdentityInfo`

```php
// 查询个人
$info = $client->auth()->getPersonIdentityInfo(psnAccount: '188****8888');

// 查询机构
$info = $client->auth()->getOrganizationIdentityInfo(orgIDCardNum: '913301********');
```

---

### 文件服务 (FileService)

用于文件的上传、下载及管理。

#### 1. 上传文件 (简化版)
`uploadFileByPath`

该方法封装了“获取上传地址”和“上传文件流”两个步骤，直接传入本地路径即可。

```php
$result = $client->file()->uploadFileByPath('/path/to/contract.pdf');
$fileId = $result['data']['fileId'];
```

#### 2. 获取文件上传地址 (原生)
`getUploadUrl`

如果需要前端直传或自定义上传逻辑，可以使用此方法获取上传 URL。

```php
$result = $client->file()->getUploadUrl(
    contentMd5: '...',
    contentType: 'application/pdf',
    fileName: 'test.pdf',
    fileSize: 1024
);
```

#### 3. 通过模板创建文件
`createFileByTemplate`

```php
$result = $client->file()->createFileByTemplate(
    templateId: 'template_id',
    name: '生成的合同.pdf',
    simpleFormFields: [
        'Name' => '张三',
        'Date' => '2023-10-01'
    ]
);
```

#### 4. 下载/查询文件
`downloadFile` / `getFileInfo`

```php
$urlData = $client->file()->downloadFile('file_id');
$info = $client->file()->getFileInfo('file_id');
```

---

### 模板服务 (TemplateService)

专注于合同模板的在线填写与控件查询。

#### 1. 获取填写合同模板页面
`getDocTemplateFillUrl`

```php
$result = $client->template()->getDocTemplateFillUrl(
    docTemplateId: 'template_id',
    componentFillingValues: [
        ['componentKey' => 'name', 'componentValue' => '李四']
    ]
);
$url = $result['data']['docTemplateFillUrl'];
```

#### 2. 查询模板控件详情
`getDocTemplateComponents`

```php
$components = $client->template()->getDocTemplateComponents('template_id');
```

#### 3. 查询填写任务结果
`getFillTaskResult`

```php
$taskResult = $client->template()->getFillTaskResult('template_id', 'fill_task_id');
```

---

### 签署流程服务 (SignFlowService)

核心业务服务，用于创建和管理签署流程。

#### 1. 基于文件创建签署流程
`createByFile`

这是发起签署最常用的接口。

```php
$result = $client->signFlow()->createByFile(
    docs: [
        ['fileId' => 'file_id', 'fileName' => '合同.pdf']
    ],
    signFlowConfig: [
        'signFlowTitle' => '测试合同',
        'autoStart' => true,
        'autoFinish' => true
    ],
    signers: [
        [
            'signerType' => 0, // 个人
            'psnSignerInfo' => ['psnAccount' => '188****8888'],
            'signFields' => [
                ['fileId' => 'file_id', 'posPage' => '1', 'posX' => 100, 'posY' => 100]
            ]
        ]
    ]
);
$signFlowId = $result['data']['signFlowId'];
```

#### 2. 获取签署页面链接
`getSignUrl`

```php
$urlData = $client->signFlow()->getSignUrl(
    signFlowId: $signFlowId,
    operator: ['psnAccount' => '188****8888']
);
$shortUrl = $urlData['data']['shortUrl'];
```

#### 3. 查询签署流程详情
`getSignFlowDetail`

```php
$detail = $client->signFlow()->getSignFlowDetail($signFlowId);
```

#### 4. 下载已签署文件及附属材料
`getFileDownloadUrl`

仅在流程状态为“完成”时可用。

```php
$files = $client->signFlow()->getFileDownloadUrl($signFlowId);
```

#### 5. 下载签署中文件 (预览)
`getPreviewFileDownloadUrl`

用于在签署过程中预览文件（带水印，不可用于存证）。

```php
$preview = $client->signFlow()->getPreviewFileDownloadUrl(
    signFlowId: $signFlowId,
    docFileId: 'doc_file_id'
);
```

---

## 错误处理

SDK 中所有服务方法在发生错误时（如 HTTP 错误、API 业务错误）都会抛出 `QingzeLab\ESignBao\Exceptions\ESignBaoException` 异常。

```php
use QingzeLab\ESignBao\Exceptions\ESignBaoException;

try {
    $client->signFlow()->createByFile(...);
} catch (ESignBaoException $e) {
    echo "错误代码: " . $e->getCode() . "\n";
    echo "错误信息: " . $e->getMessage() . "\n";
    // 如果是 API 响应错误，可以获取原始响应数据
    // print_r($e->getResponse());
}
```
